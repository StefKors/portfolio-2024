import{d as j,a as Y,u as K,r as ee,b as te,c as G,e as N,o as ne,_ as oe,f as ie,g as S,h as T,n as ae,F as se,i as w,j as re,k as R,l as V,w as H,T as z,m as B,t as le,p as de,q as ue,s as ce,v as pe,x as E,y as J,z as fe,A as O}from"./CP9jfMrk.js";import{q as we,u as ve}from"./DPuIAn4L.js";import"./BtfH3IXs.js";const me=j({ui:{primary:"green",gray:"slate",footer:{bottom:{left:"text-sm text-gray-500 dark:text-gray-400",wrapper:"border-t border-gray-200 dark:border-gray-800"}}},seo:{siteName:"Nuxt UI Pro - Docs template"},header:{logo:{alt:"",light:"",dark:""},search:!0,colorMode:!0,links:[{icon:"i-simple-icons-github",to:"https://github.com/nuxt-ui-pro/docs",target:"_blank","aria-label":"Docs template on GitHub"}]},footer:{credits:"Copyright Â© 2023",colorMode:!1,links:[{icon:"i-simple-icons-nuxtdotjs",to:"https://nuxt.com",target:"_blank","aria-label":"Nuxt Website"},{icon:"i-simple-icons-discord",to:"https://discord.com/invite/ps2h6QT",target:"_blank","aria-label":"Nuxt UI on Discord"},{icon:"i-simple-icons-x",to:"https://x.com/nuxt_js",target:"_blank","aria-label":"Nuxt on X"},{icon:"i-simple-icons-github",to:"https://github.com/nuxt/ui",target:"_blank","aria-label":"Nuxt UI on GitHub"}]},toc:{title:"Table of Contents",bottom:{title:"Community",edit:"https://github.com/nuxt-ui-pro/docs/edit/main/content",links:[{icon:"i-heroicons-star",label:"Star on GitHub",to:"https://github.com/nuxt/ui",target:"_blank"},{icon:"i-heroicons-book-open",label:"Nuxt UI Pro docs",to:"https://ui.nuxt.com/pro/guide",target:"_blank"},{icon:"i-simple-icons-nuxtdotjs",label:"Purchase a license",to:"https://ui.nuxt.com/pro/purchase",target:"_blank"}]}}}),ge={nuxt:{}},he=Y(me,ge);function W(){const i=K();return i._appConfig||(i._appConfig=ee(he)),i._appConfig}const ye={key:0},_e={key:0},ke={id:"__preview_loader"},xe=te({__name:"ContentPreviewMode",props:{previewToken:{type:String,required:!0},apiURL:{type:String,required:!0},syncPreview:{type:Function,required:!0},requestPreviewSyncAPI:{type:Function,required:!0}},setup(i){const s=i,t=["__nuxt_preview","__preview_enabled"],c=K(),y=G(),p=N(!0),x=N(!1),e=N(!1),o=N("");let n;const a=async()=>{B("previewToken").value="",window.sessionStorage.removeItem("previewToken"),window.sessionStorage.removeItem("previewAPI"),await y.replace({query:{preview:void 0}}),window.location.reload()},m=async f=>{const r=await s.syncPreview(f);if(e.value!==!0){if(!r){setTimeout(()=>m(f),1e3);return}B("previewToken").value&&(e.value=!0,await y.replace({query:{}}),c.callHook("nuxt-studio:preview:ready"),window.parent&&window.self!==window.parent&&n.disconnect())}};return ne(async()=>{n=(await oe(()=>import("./BI6ZbG9k.js"),[],import.meta.url)).connect(`${s.apiURL}/preview`,{transports:["websocket","polling"],auth:{token:s.previewToken}});let r;n.on("connect",()=>{r=setTimeout(()=>{e.value||(r=setTimeout(()=>{o.value="Preview sync timed out",e.value=!1},3e4),n.emit("draft:requestSync"))},3e4)});const I=()=>{r&&(clearTimeout(r),r=null)};n.on("draft:sync",async b=>{if(I(),!b){try{n.once("draft:ready",()=>{n.emit("draft:requestSync")}),await s.requestPreviewSyncAPI()}catch(A){switch(I(),A.response.status){case 404:o.value="Preview draft not found",e.value=!1;break;default:o.value="An error occurred while syncing preview",e.value=!1}}return}m(b)}),n.on("draft:unauthorized",()=>{I(),o.value="Unauthorized preview",e.value=!1}),n.on("disconnect",()=>{I()}),document.body.classList.add(...t),n.on("draft:update",b=>{x.value=!0,s.syncPreview(b),x.value=!1})}),ie(()=>{document.body.classList.remove(...t)}),(f,r)=>(S(),T("div",null,[p.value?(S(),T("div",{key:0,id:"__nuxt_preview",class:ae({__preview_ready:e.value,__preview_refreshing:x.value})},[e.value?(S(),T(se,{key:0},[r[0]||(r[0]=w("svg",{viewBox:"0 0 90 90",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[w("path",{d:"M50.0016 71.0999h29.2561c.9293.0001 1.8422-.241 2.6469-.6992.8047-.4582 1.4729-1.1173 1.9373-1.9109.4645-.7936.7088-1.6939.7083-2.6102-.0004-.9162-.2455-1.8163-.7106-2.6095L64.192 29.713c-.4644-.7934-1.1325-1.4523-1.937-1.9105-.8046-.4581-1.7173-.6993-2.6463-.6993-.9291 0-1.8418.2412-2.6463.6993-.8046.4582-1.4726 1.1171-1.937 1.9105l-5.0238 8.5861-9.8224-16.7898c-.4648-.7934-1.1332-1.4522-1.938-1.9102-.8047-.4581-1.7176-.6992-2.6468-.6992-.9292 0-1.842.2411-2.6468.6992-.8048.458-1.4731 1.1168-1.9379 1.9102L6.56062 63.2701c-.46512.7932-.71021 1.6933-.71061 2.6095-.00041.9163.24389 1.8166.70831 2.6102.46443.7936 1.1326 1.4527 1.93732 1.9109.80473.4582 1.71766.6993 2.64686.6992h18.3646c7.2763 0 12.6422-3.1516 16.3345-9.3002l8.9642-15.3081 4.8015-8.1925 14.4099 24.6083H54.8058l-4.8042 8.1925ZM29.2077 62.899l-12.8161-.0028L35.603 30.0869l9.5857 16.4047-6.418 10.9645c-2.4521 3.9894-5.2377 5.4429-9.563 5.4429Z",fill:"currentColor"})],-1)),r[1]||(r[1]=w("span",null,[w("a",{href:"https://nuxt.studio",target:"_blank",rel:"noopener"},"Nuxt Studio"),re(": Preview enabled")],-1)),w("button",{onClick:a}," Close ")],64)):R("",!0)],2)):R("",!0),V(z,{name:"preview-loading"},{default:H(()=>[p.value&&!e.value&&!o.value?(S(),T("div",ye,[r[4]||(r[4]=w("div",{id:"__preview_background"},null,-1)),w("div",{id:"__preview_loader"},[r[2]||(r[2]=w("svg",{id:"__preview_loading_icon",width:"32",height:"32",viewBox:"0 0 24 24"},[w("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15"})],-1)),r[3]||(r[3]=w("p",null,"Initializing the preview...",-1)),w("button",{onClick:a}," Cancel ")])])):R("",!0)]),_:1}),V(z,{name:"preview-loading"},{default:H(()=>[o.value?(S(),T("div",_e,[r[5]||(r[5]=w("div",{id:"__preview_background"},null,-1)),w("div",ke,[w("p",null,le(o.value),1),w("button",{onClick:a}," Exit preview ")])])):R("",!0)]),_:1})]))}}),Ce=de(xe,[["__scopeId","data-v-4701d75d"]]),Ie=(i=[],s,t)=>{const c=[...s||[]],y=[...t||[]],p=JSON.parse(JSON.stringify(i));for(const e of c)if(e.new)p.push({path:e.path,parsed:e.parsed});else if(e.oldPath)if(y.splice(y.findIndex(n=>n.path===e.oldPath),1),c.find(n=>n.path===e.oldPath))p.push({path:e.path,parsed:e.parsed});else{const n=p.find(a=>a.path===e.oldPath);n&&(n.path=e.path,e.parsed?n.parsed=e.parsed:e.pathMeta&&["_file","_path","_id","_locale"].forEach(a=>{n.parsed[a]=e.pathMeta[a]}))}else{const o=p.find(n=>n.path===e.path);o?Object.assign(o,{path:e.path,parsed:e.parsed}):p.push({path:e.path,parsed:e.parsed})}for(const e of y)p.splice(p.findIndex(o=>o.path===e.path),1);const x=new Intl.Collator(void 0,{numeric:!0});return p.sort((e,o)=>x.compare(e.path,o.path)),p},k={appConfig:"app.config.ts",appConfigV4:"app/app.config.ts",nuxtConfig:"nuxt.config.ts"},be=ue((i,s,t)=>{if(Array.isArray(i[s])&&Array.isArray(t))return i[s]=t,!0}),Pe=i=>{let s;return t=>(s||(s=i()),s)};function Z(i,s){for(const t in i){const c=s[t];t in s||delete i[t],c!==null&&typeof c=="object"&&Z(i[t],s[t])}}function Q(i,s){for(const t in s){const c=s[t];c!==null&&typeof c=="object"?Array.isArray(c)&&Array.isArray(i[t])?i[t]=c:(i[t]=i[t]||{},Q(i[t],c)):i[t]=c}}const Ae=()=>{const i=K(),s={},t=ce("studio-client-db",()=>null);t.value||(i.hook("content:storage",o=>{t.value=o}),we("/non-existing-path").findOne());const c=async o=>{var m,f,r;const n=window.sessionStorage.getItem("previewToken");if(!o)return null;o=o.replace(/\/$/,"");let a=await((m=t.value)==null?void 0:m.getItem(`${n}:${o}`));return a||(a=await((f=t.value)==null?void 0:f.getItem(`cached:${o}`))),a||(a=a=await((r=t.value)==null?void 0:r.getItem(o))),a||(a=s[o||"/"]),a};return{storage:t,findContentItem:c,updateContentItem:(o,n)=>{var a;t.value&&(s[n.parsed._path]=n.parsed,t.value.setItem(`${o}:${(a=n.parsed)==null?void 0:a._id}`,JSON.stringify(n.parsed)))},removeContentItem:async(o,n)=>{var m;const a=await c(n);if(await((m=t.value)==null?void 0:m.removeItem(`${o}:${n}`)),a){delete s[a._path];const f=await c(a._id);f&&(s[f._path]=f)}},removeAllContentItems:async o=>{const n=await t.value.getKeys(`${o}:`);await Promise.all(n.map(a=>t.value.removeItem(a)))},setPreviewMetaItems:async(o,n)=>{const a=new Set(n.map(m=>m.parsed._id.split(":").shift()));await t.value.setItem(`${o}$`,JSON.stringify({ignoreSources:Array.from(a)}))}}},Se=Pe(()=>JSON.parse(JSON.stringify(W())));let U=[];const Me=()=>{const i=K(),{storage:s,findContentItem:t,updateContentItem:c,removeContentItem:y,removeAllContentItems:p,setPreviewMetaItems:x}=Ae(),{studio:e,content:o}=pe().public,n=window.sessionStorage.getItem("previewAPI")||(e==null?void 0:e.apiURL),a=Se(),m=async u=>{const l=window.sessionStorage.getItem("previewToken");p(l),x(l,u),await Promise.all(u.map(v=>{c(l,v)}))},f=u=>{const l=J(i,W);l!=null&&l.ui&&(l.ui.icons={...l.ui.icons,dynamic:!0}),Q(l,be(u,a)),u||Z(l,a)},r=async u=>{if(U=u.files=u.files||U||[],!s.value)return!1;U=[];const l=Ie(u.files,u.additions,u.deletions),v=l.filter(C=>![k.appConfig,k.appConfigV4,k.nuxtConfig].includes(C.path));await m(v);const g=l.find(C=>[k.appConfig,k.appConfigV4].includes(C.path));return f(g==null?void 0:g.parsed),A(),!0},I=async()=>{const u=window.sessionStorage.getItem("previewToken");await $fetch("api/projects/preview/sync",{baseURL:n,method:"POST",params:{token:u}})},b=()=>{const u=window.sessionStorage.getItem("previewToken"),l=document.createElement("div");l.id="__nuxt_preview_wrapper",document.body.appendChild(l),fe(Ce,{previewToken:u,apiURL:n,syncPreview:r,requestPreviewSyncAPI:I}).mount(l)},A=async()=>{if(o!=null&&o.documentDriven){const{pages:u}=J(i,ve),l=await Promise.all(Object.keys(u.value).map(async v=>{var g;return await t(((g=u.value[v])==null?void 0:g._id)??v)}));u.value=l.reduce((v,g,C)=>(g&&(v[Object.keys(u.value)[C]]=g),v),{})}await i.hooks.callHookParallel("app:data:refresh")};return{mountPreviewUI:b,initiateIframeCommunication:X};function X(){if(!window.parent||window.self===window.parent)return;const u=G(),l=E(),v=N(""),g=d=>({path:d.path,query:O(d.query),params:O(d.params),fullPath:d.fullPath,meta:O(d.meta)});window.addEventListener("keydown",d=>{(d.metaKey||d.ctrlKey||d.altKey||d.shiftKey)&&window.parent.postMessage({type:"nuxt-studio:preview:keydown",payload:{key:d.key,metaKey:d.metaKey,ctrlKey:d.ctrlKey,shiftKey:d.shiftKey,altKey:d.altKey}},"*")}),window.addEventListener("message",async d=>{var F;if(!["https://nuxt.studio","https://new.nuxt.studio","https://new.dev.nuxt.studio","https://dev.nuxt.studio","http://localhost:3000",...((F=e==null?void 0:e.iframeMessagingAllowedOrigins)==null?void 0:F.split(",").map(h=>h.trim()))||[]].includes(d.origin))return;const{type:L,payload:q={}}=d.data||{};switch(L){case"nuxt-studio:editor:file-selected":{const h=await t(q.path);h&&(h._partial||!String(q.path).endsWith(".md")||h._path!==E().path&&(v.value=h._path,u.push(h._path)));break}case"nuxt-studio:editor:media-changed":case"nuxt-studio:editor:file-changed":{const h=window.sessionStorage.getItem("previewToken"),{additions:$=[],deletions:P=[]}=q;for(const M of $)await c(h,M);for(const M of P)await y(h,M.path);A();break}case"nuxt-studio:config:file-changed":{const{additions:h=[],deletions:$=[]}=q,P=h.find(D=>[k.appConfig,k.appConfigV4].includes(D.path));P&&f(P==null?void 0:P.parsed),$.find(D=>[k.appConfig,k.appConfigV4].includes(D.path))&&f(void 0)}}}),i.hook("page:finish",()=>{C(),i.payload.prerenderedAt&&A()}),i.hook("content:document-driven:finish",({route:d,page:_})=>{d.meta.studio_page_contentId=_==null?void 0:_._id}),i.hook("nuxt-studio:preview:ready",()=>{window.parent.postMessage({type:"nuxt-studio:preview:ready",payload:g(E())},"*"),setTimeout(()=>{C()},100)});function C(){const d=Array.from(window.document.querySelectorAll("[data-content-id]")).map(L=>L.getAttribute("data-content-id")),_=Array.from(new Set([l.meta.studio_page_contentId,...d])).filter(Boolean);if(v.value===_[0]){v.value="";return}window.openContentInStudioEditor(_,{navigate:!0,pageContentId:l.meta.studio_page_contentId})}window.openContentInStudioEditor=(d,_={})=>{window.parent.postMessage({type:"nuxt-studio:preview:navigate",payload:{...g(l),contentIds:d,..._}},"*")}}};export{Me as useStudio};
